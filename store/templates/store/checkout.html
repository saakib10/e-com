{% extends 'base.html' %}
{% load static %}
{% block css %}
<link rel="stylesheet" href="{% static 'css/bs-select.css' %}" type="text/css" />
<style>

	.white-section {
		background-color: #FFF;
		padding: 25px 20px;
		-webkit-box-shadow: 0px 1px 1px 0px #dfdfdf;
		box-shadow: 0px 1px 1px 0px #dfdfdf;
		border-radius: 3px;
	}

	.white-section label {
		display: block;
		margin-bottom: 15px;
	}

	.white-section pre { margin-top: 15px; }

	.dark .white-section {
		background-color: #111;
		-webkit-box-shadow: 0px 1px 1px 0px #444;
		box-shadow: 0px 1px 1px 0px #444;
	}

	</style>
{% endblock css %}
{% block content %}
    <!-- <div class="modal fade bs-example-modal-ld pop-up-item" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <h1>treeeeeeeeeeeeeee</h1>
            </div>
        </div>
    </div> -->
    <div class="cart-box-main">
        <div class="container">
            
            <div class="row col-mb-50 gutter-50 hidden">
                <div class="col-lg-6 bottommargin-sm">
                    <div class="white-section">
                        <div class="form-check">
                            <h4>Delivery Address</h4>
                            <input class="form-check-input" value="1" type="checkbox" id="gridCheck">
                            <label class="form-check-label" for="gridCheck">User Custoemr Default Address</label>
                        </div>
                    </div>
                    <div class="white-section form-address">
                        <div class="row" style="background-color: #F5F5F5; padding: 17px;">
                            <div class="col-lg-6" id="pro-id" style="padding: 18px;">
                                <label >Select Province *</label>
                                <select name="province" class="selectpicker customjs filter-item" data-size="7" data-live-search="true" title="Select Province" style="width:100%; line-height: 30px;">
                                <optgroup id="province">
                                    <option value=""></option>
                                    {% for pro in province %}
                                            <option value="{{ pro.id }}">{{ pro.name }}</option>
                                    {% endfor %}
                                </optgroup>
                                </select>
                            </div>
                            <div class="col-lg-6" id="city-id" style="padding: 18px;">
                                <label>Select City *</label>
                                    <select name="city" class="selectpicker customjs filter-item" data-size="7" data-live-search="true" title="Select City" style="width:100%; line-height: 30px;">
                                    <optgroup id="city"></optgroup>
                                </select>
                            </div>
                            <div class="col-lg-12 mt-5" id="area-id" style="padding: 18px;">
                                <label>Area *</label>
                                    <select name="area" class="selectpicker customjs filter-item" data-size="7" data-live-search="true" title="Select Area" style="width:100%; line-height: 30px;">
                                        <optgroup id="area"></optgroup>
                                    </select>
                            </div>
                            <div class="col-lg-12 mt-5" id="address-id">
                                <div class="form-group">
                                    <label for="exampleFormControlTextarea1">Address *</label>
                                    <textarea class="form-control" id="exampleFormControlTextarea1" rows="3"></textarea>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    <div class="white-section address-list d-none">
                        <div class="promo promo-light p-4 p-md-5 mb-5">
                            <div class="row align-items-center">
                                <div class="col-12 col-lg">
                                    {% if address %}
                                        {% if address.province %}<h4 class="m-1">{{ address.province }}</h4>{% endif %}
                                        {% if address.city %}<h4 class="m-1">{{ address.city }}</h4>{% endif %}
                                        {% if address.area %}<h4 class="m-1">{{ address.area }}</h4>{% endif %}
                                        {% if address.address %}
                                            <span><h4>{{ address.address }}</h4></span>
                                        {% endif %}
                                    {% else %}
                                        <h4 class="m-1">Address Not Set Yet</h4>
                                    {% endif %}
                                </div>
                                <!-- <div class="col-2 col-lg-auto mt-4 mt-lg-0"> -->
                                    <!-- <a href="#" class="button button-3d button-black m-0">Start Trial</a> -->
                                    <!-- <button class="button button-3d button-black m-0 button button-3d button-black m-0" data-bs-toggle="modal" data-bs-target=".bs-example-modal-ld" onclick="item_popup({{ product.id }})">Edit</button> -->
                                <!-- </div> -->
                            </div>
                        </div>
                    </div>

                </div>
                
                <div class="col-lg-6">
                    <h4>Cart Totals</h4>

                    <div class="table-responsive">
                        <table class="table cart">
                            <tbody>
                                <tr class="cart_item">
                                    <td class="border-top-0 cart-product-name">
                                        <strong>Cart Subtotal</strong>
                                    </td>

                                    <td class="border-top-0 cart-product-name">
                                        <span class="amount">{{ order.get_cart_items }}</span>
                                    </td>
                                </tr>
                                <tr class="cart_item">
                                    <td class="cart-product-name">
                                        <strong>Total</strong>
                                    </td>

                                    <td class="cart-product-name">
                                        <span class="amount color lead"><strong>${{ order.get_cart_total }}</strong></span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="button button-3d button-black m-0" id="place-order">Place Order</button>
                </div>


                <div class="w-100"></div>
                {% if item %}
                <div class="col-lg-6">
                    <h4>Your Orders</h4>

                    <div class="table-responsive">
                        <table class="table cart mb-5">
                            <thead>
                                <tr>
                                    <th class="cart-product-thumbnail">&nbsp;</th>
                                    <th class="cart-product-name">Product</th>
                                    <th class="cart-product-price">Unit Price</th>
                                    <th class="cart-product-quantity">Quantity</th>
                                    <th class="cart-product-subtotal">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr class="cart_item">
                                    <td class="cart-product-thumbnail">
                                        <a href="#"><img width="64" height="64" src="{{ item.product.imagesURL }}" alt="{{ item.product.name }}"></a>
                                    </td>
                
                                    <td class="cart-product-name">
                                        <a href="#">{{ item.product.name }}</a>
                                    </td>
                
                                    <td class="cart-product-price">
                                        <span class="amount">${{ item.product.price }}</span>
                                    </td>
                
                                    <td class="cart-product-quantity">
                                        <div class="quantity">
                                            <input type="text" name="quantity" value="{{ item.quantity }}" class="qty">
                                        </div>
                                    </td>
                
                                    <td class="cart-product-subtotal">
                                        <span class="amount">${{ item.get_total }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>

        </div>
    </div>

{% endblock content %}

{% block js %}
<script>
    $('#gridCheck').on('change', function(){
        this.value = this.checked ? 1 : 0;
        if (this.value == 1) {
            $(".form-address").addClass("d-none");
            $(".address-list").removeClass("d-none")
            var total = '{{ order.get_cart_total }}'
        }else {
            $(".address-list").addClass("d-none");
            $(".form-address").removeClass("d-none")
        }
     }).change();
</script>
    
    <script type="text/javascript">
        
        $("#place-order").on('click', function(){

            let user_address = $("#gridCheck").val()
            if (user_address == 1) {
                var total = '{{ order.get_cart_total }}'
                var url = '/process_order/'
                fetch(url, {
                    method : 'POST',
                    headers : {
                        'Content-Type':'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body:JSON.stringify({'total':total,'user_address':user_address})

                })
                .then((response) => response.json())
                .then((data) => {
                    alert('transaction complete');
                    window.location.href = "{% url 'shop' %}"
                })
            }else{

                // validate Form 
                province = $('#province').parent().val()
                city = $('#city').parent().val()
                area = $('#area').parent().val()
                address = $('#exampleFormControlTextarea1').val()

                if (province == "") {
                    $('#pro-id').css("box-shadow","0 0 5px 2px #be4e4e")
                }
                if (city == "") {
                    $('#city-id').css("box-shadow","0 0 5px 2px #be4e4e")
                }
                if (area == "") {
                    $('#area-id').css("box-shadow","0 0 5px 2px #be4e4e")
                }if (address == "") {
                    $('#address-id').css("box-shadow","0 0 5px 2px #be4e4e")
                }
                if (province && city && area && address){
                    var total = '{{ order.get_cart_total }}'

                    var customerInfo = {
                        'province' : null,
                        'city' : null,
                        'area' : null,
                        'address' : null,
                        total: total
                    }

                    customerInfo.province = province
                    customerInfo.city = city
                    customerInfo.area = area
                    customerInfo.address = address

                    var url = '/process_order/'
                    fetch(url, {
                        method : 'POST',
                        headers : {
                            'Content-Type':'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                        body:JSON.stringify({'form':customerInfo})

                    })
                    .then((response) => response.json())
                    .then((data) => {
                        alert('transaction complete');
                        window.location.href = "{% url 'shop' %}"
                    })
                }

            }

            
        })

    </script>
    
<script>
    $(document).ready(function() {

        $('#province').parent().on('change', function() {
            let province = $('#province').parent().val()
            $.ajax({
            url: '{% url "province" %}',
            type: 'GET',
            data : {
                    'province': province
            },
            success: function(resp){
                $('#city').empty()
                $('#area').empty()
                resp.data.forEach(x => {
                    $(`<option value="${ x.id }">${ x.name }</option>`).appendTo($("#city"))
                });
                $('#city').parent().selectpicker('refresh');
            }
        });
      })
      $('#city').parent().on('change', function() {
        let city = $('#city').parent().val()
        $.ajax({
          url: '{% url "city" %}',
          type: 'GET',
          data : {
                  'city': city
          },
        success: function(resp){
            $('#area').empty()
            resp.data.forEach(x => {
            $(`<option value="${ x.name }">${ x.name }</option>`).appendTo($("#area"))
            });
            $('#area').parent().selectpicker('refresh');
        }
      });
      })
    })
    
</script>


{% endblock js %}
